<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .setup-panel {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed #cbd5e0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-group input[type="file"],
        .form-group input[type="password"],
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            height: 120px;
            resize: vertical;
        }
        
        .button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .results-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
        }
        
        .result-item {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #10b981;
        }
        
        .result-item.error {
            border-left-color: #ef4444;
        }
        
        .result-ticker {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .result-json {
            background: #1f2937;
            color: #e5e7eb;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .status {
            font-size: 14px;
            color: #6b7280;
            margin-top: 10px;
        }
        
        .ticker-list {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e2e8f0;
        }
        
        .ticker-item {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 12px;
        }
        
        .export-buttons {
            margin-top: 15px;
        }
        
        .export-buttons button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Stock Analysis Tool</h1>
            <p>Upload CSV with tickers and generate AI-powered stock analysis</p>
        </div>
        
        <div class="setup-panel">
            <div class="form-group">
                <label for="csvFile">Select CSV File with Tickers:</label>
                <input type="file" id="csvFile" accept=".csv,.txt" />
                <div id="tickerPreview" class="ticker-list" style="display: none;">
                    <strong>Found tickers:</strong>
                    <div id="tickerList"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="apiKey">OpenAI API Key:</label>
                <input type="password" id="apiKey" placeholder="sk-..." />
            </div>
            
            <div class="form-group">
                <label for="modelSelect">OpenAI Model:</label>
                <select id="modelSelect" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                    <option value="gpt-5-mini">GPT-5 Mini (Fast & Cost-effective)</option>
                    <option value="gpt-4">GPT-4 (Higher Quality)</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo (Latest)</option>
                    <option value="gpt-4o">GPT-4o (Multimodal)</option>
                    <option value="gpt-4o-mini">GPT-4o Mini (Efficient)</option>

                </select>
            </div>
            
            <div class="form-group">
                <label for="prompt">Analysis Prompt:</label>
                <textarea id="prompt" placeholder="Enter your prompt for analyzing each stock ticker...">Analyze the stock with ticker "{TICKER}" and provide a comprehensive financial analysis. Return the response as a JSON object with the following structure:

Analyze the stock with ticker "{TICKER}" and provide a comprehensive, up-to-date financial analysis. Return the response strictly as a JSON object with the following structure:

{
  "company_name": "Company Name",
  "ticker": "{TICKER}",
  "PE_TTM": null,
  "last_quarter_to_prev_quarter_revenue_growth": 0,
  "last_quarter_to_prev_quarter_FCF_growth": 0,
  "current_price_usd": 0,
  "52_week_high_usd": 0,
  "price_to_52_week_high": 0,
  "analyst_price_targets": {
    "consensus": 0,
    "low": 0,
    "high": 0,
    "median": 0
  },
  "revenue_growth": {
    "ttm": 0,
    "quarterly": 0
  },
  "profitability": {
    "net_income_margin": 0,
    "gross_margin": 0
  },
  "current_decision": "monitor/disqualify",
  "disqualify_reason": "reason if disqualified",
  "next_action": "recommended next action"
}

Requirements:

1. Use **real, up-to-date financial data** from reliable sources.
2. 2. Calculate "last_quarter_to_prev_quarter_revenue_growth" and "last_quarter_to_prev_quarter_FCF_growth" **only using the two most recent fully reported quarters**.  
   - Let Qn = most recent fully reported quarter (e.g., Q2 2025)  
   - Let Qn-1 = quarter immediately before that (e.g., Q1 2025)  

   Formulas:  
   last_quarter_to_prev_quarter_revenue_growth = (Revenue_Qn – Revenue_Qn-1) / Revenue_Qn-1  
   last_quarter_to_prev_quarter_FCF_growth = (FCF_Qn – FCF_Qn-1) / FCF_Qn-1
   These are critical for the decision-making logic.
3. Set `"current_decision"` as follows:
   - `"disqualify"` if **both** last quarter revenue growth and FCF growth are negative.
   - Otherwise, set `"monitor"`.
4. Provide a **clear reason** in `"disqualify_reason"` if disqualified, otherwise leave it null.
5. Suggest the `"next_action"` based on the financial trends and recovery potential.
6. Ensure all numeric fields are actual numbers, not strings or placeholders.
7. Do **not** add any text outside the JSON object; return only the JSON.</textarea>
            </div>
            
            <button class="button" id="startAnalysis">Start Analysis</button>
        </div>
        
        <div class="progress-panel" id="progressPanel">
            <h3>Processing...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status" id="statusText">Preparing analysis...</div>
        </div>
        
        <div class="results-panel" id="resultsPanel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Analysis Results</h3>
                <div class="export-buttons">
                    <button class="button" id="exportJson">Export as JSON</button>
                    <button class="button" id="exportCsv">Export as CSV</button>
                </div>
            </div>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        let tickers = [];
        let results = [];
        let isProcessing = false;

        document.getElementById('csvFile').addEventListener('change', handleFileSelect);
        document.getElementById('startAnalysis').addEventListener('click', startAnalysis);
        document.getElementById('exportJson').addEventListener('click', exportAsJson);
        document.getElementById('exportCsv').addEventListener('click', exportAsCsv);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    tickers = content.split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                    
                    displayTickerPreview();
                };
                reader.readAsText(file);
            }
        }

        function displayTickerPreview() {
            const preview = document.getElementById('tickerPreview');
            const list = document.getElementById('tickerList');
            
            list.innerHTML = '';
            tickers.forEach(ticker => {
                const span = document.createElement('span');
                span.className = 'ticker-item';
                span.textContent = ticker;
                list.appendChild(span);
            });
            
            preview.style.display = 'block';
        }

        async function startAnalysis() {
            if (tickers.length === 0) {
                alert('Please select a CSV file with tickers first.');
                return;
            }
            
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Please enter your OpenAI API key.');
                return;
            }
            
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                alert('Please enter an analysis prompt.');
                return;
            }
            
            if (isProcessing) {
                return;
            }
            
            isProcessing = true;
            results = [];
            
            document.getElementById('startAnalysis').disabled = true;
            document.getElementById('progressPanel').style.display = 'block';
            document.getElementById('resultsPanel').style.display = 'block';
            document.getElementById('resultsContainer').innerHTML = '';
            
            for (let i = 0; i < tickers.length; i++) {
                const ticker = tickers[i];
                const progress = ((i + 1) / tickers.length) * 100;
                
                updateProgress(progress, `Analyzing ${ticker} (${i + 1}/${tickers.length})`);
                
                try {
                    const result = await analyzeStock(ticker, prompt, apiKey);
                    results.push(result);
                    displayResult(result, false);
                } catch (error) {
                    const errorResult = {
                        ticker: ticker,
                        error: error.message,
                        timestamp: new Date().toISOString()
                    };
                    results.push(errorResult);
                    displayResult(errorResult, true);
                }
                
                // Add a small delay to avoid rate limiting
                if (i < tickers.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            updateProgress(100, 'Analysis complete!');
            document.getElementById('startAnalysis').disabled = false;
            isProcessing = false;
        }

        async function analyzeStock(ticker, prompt, apiKey) {
            const personalizedPrompt = prompt.replace(/\{TICKER\}/g, ticker);
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: personalizedPrompt
                        }
                    ],
                    temperature: 0.3
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`OpenAI API Error: ${errorData.error?.message || response.statusText}`);
            }
            
            const data = await response.json();
            const content = data.choices[0].message.content;
            
            try {
                // Try to extract JSON from the response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    throw new Error('No JSON found in response');
                }
            } catch (parseError) {
                // If JSON parsing fails, return raw content
                return {
                    ticker: ticker,
                    raw_response: content,
                    parse_error: parseError.message
                };
            }
        }

        function updateProgress(percentage, status) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('statusText').textContent = status;
        }

        function displayResult(result, isError) {
            const container = document.getElementById('resultsContainer');
            const item = document.createElement('div');
            item.className = `result-item ${isError ? 'error' : ''}`;
            
            const tickerDiv = document.createElement('div');
            tickerDiv.className = 'result-ticker';
            tickerDiv.textContent = `${result.ticker} ${isError ? '❌' : '✅'}`;
            
            const jsonDiv = document.createElement('div');
            jsonDiv.className = 'result-json';
            jsonDiv.textContent = JSON.stringify(result, null, 2);
            
            item.appendChild(tickerDiv);
            item.appendChild(jsonDiv);
            container.appendChild(item);
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function exportAsJson() {
            if (results.length === 0) {
                alert('No results to export.');
                return;
            }
            
            const dataStr = JSON.stringify(results, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `stock_analysis_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function exportAsCsv() {
            if (results.length === 0) {
                alert('No results to export.');
                return;
            }
            
            // Flatten the nested JSON structure for CSV
            const flatResults = results.map(result => {
                if (result.error) {
                    return {
                        ticker: result.ticker,
                        error: result.error,
                        timestamp: result.timestamp
                    };
                }
                
                return {
                    ticker: result.ticker || '',
                    company_name: result.company_name || '',
                    PE_TTM: result.PE_TTM || '',
                    current_price_usd: result.current_price_usd || '',
                    '52_week_high_usd': result['52_week_high_usd'] || '',
                    price_to_52_week_high: result.price_to_52_week_high || '',
                    consensus_target: result.analyst_price_targets?.consensus || '',
                    target_low: result.analyst_price_targets?.low || '',
                    target_high: result.analyst_price_targets?.high || '',
                    revenue_growth_ttm: result.revenue_growth?.ttm || '',
                    revenue_growth_quarterly: result.revenue_growth?.quarterly || '',
                    net_income_margin: result.profitability?.net_income_margin || '',
                    gross_margin: result.profitability?.gross_margin || '',
                    current_decision: result.current_decision || '',
                    disqualify_reason: result.disqualify_reason || '',
                    next_action: result.next_action || ''
                };
            });
            
            if (flatResults.length === 0) return;
            
            const headers = Object.keys(flatResults[0]);
            const csvContent = [
                headers.join(','),
                ...flatResults.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' && value.includes(',') 
                            ? `"${value}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');
            
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
            const exportFileDefaultName = `stock_analysis_${new Date().toISOString().split('T')[0]}.csv`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
    </script>
</body>
</html>