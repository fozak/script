<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Direct SQLite File Access</title>
<style>
body { font-family: monospace; padding: 20px; }
button { padding: 8px 16px; margin: 5px; }
.file-item { padding: 5px; cursor: pointer; color: blue; border: 1px solid #ddd; margin: 2px; }
iframe { width: 100%; height: 250px; border: 1px solid #ccc; margin-top: 10px; }
#status { padding: 10px; background: #f0f0f0; margin: 10px 0; }
.error { background: yellow; color: red; }
</style>
</head>
<body>

<h2>Direct SQLite File Access</h2>
<button id="openDb">Open SQLite File</button>
<input type="file" id="fileInput" multiple disabled>
<div id="status">Chrome/Edge required. Click Open SQLite File.</div>
<div id="fileList"></div>
<iframe id="preview"></iframe>

<script src="jswasm/sqlite3.js"></script>
<script>
let db, sqlite3, fileHandle;

// Check browser support
if (!('showOpenFilePicker' in window)) {
  document.getElementById('status').innerHTML = '<span class="error">File System Access API not supported. Use Chrome/Edge.</span>';
}

// Initialize SQLite
sqlite3InitModule().then(s3 => { sqlite3 = s3; });

// Open local SQLite file with persistent access
document.getElementById('openDb').onclick = async () => {
  try {
    // Get persistent file handle
    [fileHandle] = await window.showOpenFilePicker({
      types: [{ description: 'SQLite', accept: { 'application/x-sqlite3': ['.sqlite', '.db'] } }]
    });

    // Read file content
    const file = await fileHandle.getFile();
    const data = new Uint8Array(await file.arrayBuffer());
    
    // Create SQLite DB - try different initialization methods
    if (data.length > 0) {
      try {
        db = new sqlite3.oo1.DB(data);
        console.log('DB created with oo1.DB');
      } catch (e) {
        console.log('oo1.DB failed, trying alternatives');
        db = new sqlite3.Database(data);
      }
    } else {
      try {
        db = new sqlite3.oo1.DB();
        console.log('Empty DB created with oo1.DB');
      } catch (e) {
        db = new sqlite3.Database();
      }
    }
    
    console.log('DB object methods:', Object.getOwnPropertyNames(db));
    console.log('DB prototype methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(db)));
    
    // Create table if needed
    db.exec(`CREATE TABLE IF NOT EXISTS files (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT, content BLOB, size INTEGER
    )`);
    
    document.getElementById('fileInput').disabled = false;
    document.getElementById('status').textContent = `Connected to: ${file.name}`;
    updateFileList();
    
  } catch (error) {
    document.getElementById('status').innerHTML = `<span class="error">${error.message}</span>`;
  }
};

// Add files and auto-save to local file
document.getElementById('fileInput').onchange = async (e) => {
  if (!db || !fileHandle) return;
  
  for (const file of e.target.files) {
    const content = new Uint8Array(await file.arrayBuffer());
    const stmt = db.prepare("INSERT INTO files (name, content, size) VALUES (?, ?, ?)");
    stmt.bind([file.name, content, file.size]);
    stmt.step();
    stmt.finalize();
  }
  
  // Write directly to local file
  await saveToLocalFile();
  updateFileList();
  document.getElementById('status').textContent = `Added ${e.target.files.length} files. Saved to local file.`;
};

// Save database to local file
async function saveToLocalFile() {
  const writable = await fileHandle.createWritable();
  const data = sqlite3.capi.sqlite3_js_db_export(db.pointer);
  await writable.write(data);
  await writable.close();
}

// Update file list
function updateFileList() {
  const list = document.getElementById('fileList');
  const result = db.exec("SELECT id, name, size FROM files");
  
  list.innerHTML = '';
  if (result[0]?.values?.length) {
    result[0].values.forEach(([id, name, size]) => {
      const div = document.createElement('div');
      div.className = 'file-item';
      div.textContent = `${name} (${(size/1024).toFixed(1)}KB)`;
      div.onclick = () => previewFile(id);
      list.appendChild(div);
    });
  } else {
    list.innerHTML = 'No files stored.';
  }
}

// Preview file
function previewFile(id) {
  const result = db.exec("SELECT name, content FROM files WHERE id = ?", [id]);
  if (result[0]?.values?.length) {
    const [name, content] = result[0].values[0];
    const blob = new Blob([content], { type: name.endsWith('.html') ? 'text/html' : 'text/plain' });
    document.getElementById('preview').src = URL.createObjectURL(blob);
  }
}
</script>

</body>
</html>