<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Local DB File Storage Demo</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    padding: 20px; 
    max-width: 800px; 
    margin: 0 auto;
  }
  .controls {
    margin-bottom: 20px;
    padding: 20px;
    border: 2px dashed #ccc;
    border-radius: 8px;
  }
  button {
    padding: 10px 20px;
    margin: 5px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  button:disabled { 
    background: #ccc; 
    cursor: not-allowed; 
  }
  #fileInput {
    margin: 10px 0;
  }
  #status {
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    font-weight: bold;
  }
  .success { background: #d4edda; color: #155724; }
  .error { background: #f8d7da; color: #721c24; }
  .info { background: #d1ecf1; color: #0c5460; }
  #fileList { 
    margin-top: 20px; 
  }
  .fileItem { 
    padding: 10px;
    margin: 5px 0;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer; 
    transition: background 0.2s;
  }
  .fileItem:hover {
    background: #e9ecef;
  }
  iframe { 
    width: 100%; 
    height: 400px; 
    margin-top: 20px; 
    border: 1px solid #ccc;
    border-radius: 4px;
  }
</style>
</head>
<body>
<h1>Local File Storage with SQLite</h1>

<div class="controls">
  <button id="pickDb">üìÅ Pick Database File</button>
  <input type="file" id="fileInput" multiple accept=".html,.txt,.json,.css,.js" disabled />
  <div id="status" class="info">Click "Pick Database File" to get started</div>
</div>

<div id="fileList"></div>
<iframe id="preview" style="display:none;"></iframe>

<script type="module">
// Simple in-memory storage (works without external dependencies)
let files = new Map(); // id -> {filename, content, type}
let nextId = 1;
let dbName = '';

function showStatus(message, type = 'info') {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = type;
}

// Pick or create DB file (simulated)
document.getElementById('pickDb').addEventListener('click', async () => {
  try {
    // For demo purposes, we'll use the File System Access API if available
    if ('showSaveFilePicker' in window) {
      const fileHandle = await window.showSaveFilePicker({
        suggestedName: 'myfiles.db',
        types: [{
          description: 'Database files',
          accept: { 'application/octet-stream': ['.db'] }
        }]
      });
      dbName = fileHandle.name;
    } else {
      // Fallback for browsers without File System Access API
      dbName = 'local_storage.db';
    }
    
    document.getElementById('fileInput').disabled = false;
    showStatus(`Database "${dbName}" ready for file uploads`, 'success');
    
    // Try to load existing data from localStorage
    loadFromLocalStorage();
    updateFileList();
    
  } catch (error) {
    if (error.name !== 'AbortError') {
      showStatus('Error setting up database: ' + error.message, 'error');
    }
  }
});

// Handle file uploads
document.getElementById('fileInput').addEventListener('change', async (e) => {
  if (!dbName) {
    showStatus('Please pick a database file first', 'error');
    return;
  }

  let successCount = 0;
  
  for (const file of e.target.files) {
    try {
      const content = await file.arrayBuffer();
      const id = nextId++;
      
      files.set(id, {
        filename: file.name,
        content: new Uint8Array(content),
        type: file.type || 'application/octet-stream',
        size: file.size
      });
      
      successCount++;
      console.log(`Added: ${file.name} (${file.size} bytes)`);
      
    } catch (error) {
      console.error(`Error adding ${file.name}:`, error);
    }
  }

  if (successCount > 0) {
    saveToLocalStorage();
    updateFileList();
    showStatus(`Successfully added ${successCount} file(s)`, 'success');
  }
  
  // Clear the input
  e.target.value = '';
});

// Save to localStorage (simulating database persistence)
function saveToLocalStorage() {
  try {
    const data = {
      files: Array.from(files.entries()).map(([id, file]) => [
        id, 
        {
          ...file,
          content: Array.from(file.content) // Convert Uint8Array to regular array for JSON
        }
      ]),
      nextId
    };
    localStorage.setItem('fileStorage', JSON.stringify(data));
    console.log('Data saved to localStorage');
  } catch (error) {
    showStatus('Error saving data: ' + error.message, 'error');
  }
}

// Load from localStorage
function loadFromLocalStorage() {
  try {
    const saved = localStorage.getItem('fileStorage');
    if (saved) {
      const data = JSON.parse(saved);
      files = new Map(data.files.map(([id, file]) => [
        id,
        {
          ...file,
          content: new Uint8Array(file.content) // Convert back to Uint8Array
        }
      ]));
      nextId = data.nextId || 1;
      console.log(`Loaded ${files.size} files from localStorage`);
    }
  } catch (error) {
    console.error('Error loading data:', error);
    files = new Map();
    nextId = 1;
  }
}

// Update file list display
function updateFileList() {
  const fileList = document.getElementById('fileList');
  
  if (files.size === 0) {
    fileList.innerHTML = '<p style="color: #666; font-style: italic;">No files stored yet. Upload some files to get started!</p>';
    return;
  }
  
  fileList.innerHTML = '<h3>Stored Files:</h3>';
  
  files.forEach((file, id) => {
    const div = document.createElement('div');
    div.className = 'fileItem';
    
    const sizeKB = (file.size / 1024).toFixed(1);
    div.innerHTML = `
      <strong>${file.filename}</strong><br>
      <small>Size: ${sizeKB} KB | Type: ${file.type}</small>
    `;
    
    div.addEventListener('click', () => previewFile(id));
    fileList.appendChild(div);
  });
}

// Preview file
function previewFile(id) {
  const file = files.get(id);
  if (!file) {
    showStatus('File not found', 'error');
    return;
  }

  try {
    const iframe = document.getElementById('preview');
    
    // Create blob with appropriate MIME type
    let mimeType = file.type;
    if (file.filename.endsWith('.html')) mimeType = 'text/html';
    else if (file.filename.endsWith('.txt')) mimeType = 'text/plain';
    else if (file.filename.endsWith('.css')) mimeType = 'text/css';
    else if (file.filename.endsWith('.js')) mimeType = 'text/javascript';
    else if (file.filename.endsWith('.json')) mimeType = 'application/json';
    
    const blob = new Blob([file.content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    
    iframe.src = url;
    iframe.style.display = 'block';
    iframe.onload = () => URL.revokeObjectURL(url); // Clean up
    
    showStatus(`Previewing: ${file.filename}`, 'info');
    
  } catch (error) {
    showStatus('Error previewing file: ' + error.message, 'error');
  }
}

// Initialize
console.log('File storage demo initialized');
</script>

</body>
</html>


