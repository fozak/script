<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SQLite File Storage</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
button { padding: 8px 16px; margin: 5px; }
.file-item { padding: 5px; cursor: pointer; color: blue; border: 1px solid #ddd; margin: 2px; }
iframe { width: 100%; height: 300px; border: 1px solid #ccc; margin-top: 10px; }
#status { padding: 10px; background: #f0f0f0; margin: 10px 0; }
</style>
</head>
<body>

<h2>SQLite File Storage</h2>
<input type="file" id="dbInput" accept=".sqlite,.db" title="Select SQLite DB file">
<input type="file" id="fileInput" multiple disabled title="Add files to DB">
<button id="saveDb" disabled>Save DB</button>

<div id="status">Select a SQLite DB file first</div>
<div id="fileList"></div>
<iframe id="preview"></iframe>

<script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
<script>
let db;
let dbFileName = '';

// Load or create SQLite DB
document.getElementById('dbInput').onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  dbFileName = file.name;
  const arrayBuffer = await file.arrayBuffer();
  
  const SQL = await initSqlJs({
    locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${file}`
  });
  
  try {
    // Try to load existing DB
    db = new SQL.Database(new Uint8Array(arrayBuffer));
    
    // Check if files table exists, create if not
    const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='files'");
    if (tables.length === 0) {
      db.run("CREATE TABLE files (id INTEGER PRIMARY KEY, name TEXT, content BLOB)");
    }
  } catch (error) {
    // If loading fails, create new DB
    db = new SQL.Database();
    db.run("CREATE TABLE files (id INTEGER PRIMARY KEY, name TEXT, content BLOB)");
  }
  
  document.getElementById('fileInput').disabled = false;
  document.getElementById('saveDb').disabled = false;
  document.getElementById('status').textContent = `DB loaded: ${dbFileName}`;
  
  updateFileList();
};

// Add files to DB
document.getElementById('fileInput').onchange = async (e) => {
  if (!db) return alert('Select DB file first');
  
  for (const file of e.target.files) {
    const arrayBuffer = await file.arrayBuffer();
    const content = new Uint8Array(arrayBuffer);
    
    db.run("INSERT INTO files (name, content) VALUES (?, ?)", [file.name, content]);
    console.log(`Added: ${file.name}`);
  }
  
  updateFileList();
  document.getElementById('status').textContent = `Added ${e.target.files.length} files. Click Save DB to persist.`;
};

// Update file list
function updateFileList() {
  const list = document.getElementById('fileList');
  list.innerHTML = '';
  
  try {
    const stmt = db.prepare("SELECT id, name FROM files");
    while (stmt.step()) {
      const row = stmt.getAsObject();
      const div = document.createElement('div');
      div.className = 'file-item';
      div.textContent = row.name;
      div.onclick = () => previewFile(row.id);
      list.appendChild(div);
    }
    stmt.free();
  } catch (e) {
    list.innerHTML = 'No files in database';
  }
}

// Preview file
function previewFile(id) {
  const stmt = db.prepare("SELECT name, content FROM files WHERE id = ?");
  stmt.bind([id]);
  
  if (stmt.step()) {
    const row = stmt.getAsObject();
    const content = new Uint8Array(row.content);
    const blob = new Blob([content], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    document.getElementById('preview').src = url;
  }
  stmt.free();
}

// Save DB to file
document.getElementById('saveDb').onclick = () => {
  if (!db) return;
  
  const data = db.export();
  const blob = new Blob([data], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = dbFileName || 'files.sqlite';
  a.click();
  URL.revokeObjectURL(url);
  
  document.getElementById('status').textContent = `Database saved as ${dbFileName || 'files.sqlite'}`;
};
</script>

</body>
</html>


