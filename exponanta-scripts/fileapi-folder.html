<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Persistent Folder Access (Global Handle)</title>
</head>
<body>
<h1>Persistent Folder Access Demo</h1>
<button id="pick-folder">Pick Folder</button>
<ul id="file-list"></ul>

<script>
// ----- IndexedDB helpers -----
const dbName = "folderHandlesDB";
const storeName = "handles";

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, 1);
        request.onupgradeneeded = (event) => {
            event.target.result.createObjectStore(storeName);
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function saveHandle(handle) {
    const db = await openDB();
    const tx = db.transaction(storeName, 'readwrite');
    tx.objectStore(storeName).put(handle, 'folderHandle');
    await tx.complete;
}

async function getHandle() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readonly');
        const request = tx.objectStore(storeName).get('folderHandle');
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// ----- Function to log first 10 symbols of every file -----
async function logFirst10Symbols(dirHandle) {
    for await (const [name, entry] of dirHandle.entries()) {
        if (entry.kind === "file") {
            try {
                const file = await entry.getFile();
                const text = await file.text();
                console.log(`${name}: ${text.slice(0, 10)}`);
            } catch (err) {
                console.warn(`Could not read file ${name}:`, err);
            }
        }
    }
}

// ----- Folder access logic -----
async function requestFolderAccess() {
    let dirHandle = await getHandle();
    if (dirHandle) {
        const permission = await dirHandle.queryPermission({ mode: 'readwrite' });
        if (permission === 'granted' || 
            await dirHandle.requestPermission({ mode: 'readwrite' }) === 'granted') {
            window.dirHandle = dirHandle;  // expose globally
            logFirst10Symbols(window.dirHandle);
            return;
        }
    }

    // Prompt user to pick folder
    dirHandle = await window.showDirectoryPicker();
    await saveHandle(dirHandle);
    window.dirHandle = dirHandle; // expose globally
    logFirst10Symbols(window.dirHandle);
}

// ----- Event listener -----
document.getElementById('pick-folder').addEventListener('click', requestFolderAccess);

// ----- Auto-load on page load (optional) -----
window.addEventListener('DOMContentLoaded', async () => {
    const storedHandle = await getHandle();
    if (storedHandle) {
        const permission = await storedHandle.queryPermission({ mode: 'readwrite' });
        if (permission === 'granted') {
            window.dirHandle = storedHandle; // expose globally
            logFirst10Symbols(window.dirHandle);
        }
    }
});
</script>
</body>
</html>

