<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approval-Enhanced Document Status UI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div id="root" class="p-6"></div>

<script type="text/javascript">
const { useState, useEffect } = React;

// --- Icon Component ---
const Icon = ({ name, size = 16 }) => {
    useEffect(() => { lucide.createIcons(); }, []);
    return React.createElement('i', { 'data-lucide': name, className: 'inline', style: { width: size, height: size } });
};

// --- Workflow JSON ---
const workflowJson = {
    states: [
        { state_name: "draft", component_type: "form", doctype: "SalesInvoice" },
        { state_name: "pending_l1_approval", component_type: "form", doctype: "SalesInvoice" },
        { state_name: "pending_l2_approval", component_type: "form", doctype: "SalesInvoice" },
        { state_name: "pending_l3_approval", component_type: "form", doctype: "SalesInvoice" },
        { state_name: "approved", component_type: "info" },
        { state_name: "rejected", component_type: "info" }
    ],
    transitions: [
        { state: "draft", action: "submit", next_state: "pending_l1_approval", allowed: "owner", idx: 1 },
        { state: "pending_l1_approval", action: "approve_l1", next_state: "pending_l2_approval", allowed: "sales_manager", idx: 1 },
        { state: "pending_l1_approval", action: "reject", next_state: "rejected", allowed: "sales_manager", idx: 2 },
        { state: "pending_l2_approval", action: "approve_l2", next_state: "pending_l3_approval", allowed: "finance_manager", idx: 1 },
        { state: "pending_l2_approval", action: "reject", next_state: "rejected", allowed: "finance_manager", idx: 2 },
        { state: "pending_l3_approval", action: "approve_l3", next_state: "approved", allowed: "ceo", idx: 1 },
        { state: "pending_l3_approval", action: "reject", next_state: "rejected", allowed: "ceo", idx: 2 }
    ],
    action_masters: [
        { action_name: "submit", action_label: "Submit", action_type: "submit", button_class: "bg-blue-600 hover:bg-blue-700 text-white", requires_comment: false },
        { action_name: "approve_l1", action_label: "Approve L1", action_type: "approve", button_class: "bg-green-600 hover:bg-green-700 text-white", requires_comment: false },
        { action_name: "approve_l2", action_label: "Approve L2", action_type: "approve", button_class: "bg-green-600 hover:bg-green-700 text-white", requires_comment: false },
        { action_name: "approve_l3", action_label: "Final Approve", action_type: "approve", button_class: "bg-green-600 hover:bg-green-700 text-white", requires_comment: false },
        { action_name: "reject", action_label: "Reject", action_type: "reject", button_class: "bg-red-600 hover:bg-red-700 text-white", requires_comment: true }
    ]
};

// --- Workflow Buttons ---
function WorkflowButtons({ currentDoc, workflow, user, onAction }) {
    const allowedTransitions = workflow.transitions
        .filter(t => t.state === currentDoc.workflow_state)
        .filter(t => !t.allowed || t.allowed === user.role)
        .sort((a, b) => a.idx - b.idx);

    return (
        React.createElement('div', { className: 'flex flex-wrap gap-3' },
            allowedTransitions.map(t => {
                const actionMeta = workflow.action_masters.find(a => a.action_name === t.action);
                if (!actionMeta) return null;
                return React.createElement('button', {
                    key: `${t.state}_${t.action}_${t.idx}`,
                    className: `px-4 py-2 rounded font-medium ${actionMeta.button_class}`,
                    onClick: () => onAction(t)
                }, actionMeta.action_label);
            })
        )
    );
}

// --- Main UI ---
const ApprovalEnhancedDocumentUI = () => {
    const [currentDoc, setCurrentDoc] = useState({
        id: 'SI-001',
        title: 'Sales Invoice #2024-001',
        doctype: 'Sales Invoice',
        docstatus: 0,
        workflow_state: 'draft',
        amount: 15000,
        owner: 'john@company.com',
        current_user: 'sarah@company.com'
    });

    const getStatusBadge = (state) => {
        const map = {
            draft: { label: 'Draft', color: 'bg-gray-100 text-gray-700', icon: 'edit-3' },
            pending_l1_approval: { label: 'Pending L1', color: 'bg-yellow-100 text-yellow-700', icon: 'user-check' },
            pending_l2_approval: { label: 'Pending L2', color: 'bg-orange-100 text-orange-700', icon: 'users' },
            pending_l3_approval: { label: 'Pending L3', color: 'bg-purple-100 text-purple-700', icon: 'crown' },
            approved: { label: 'Approved', color: 'bg-green-100 text-green-700', icon: 'check-circle-2' },
            rejected: { label: 'Rejected', color: 'bg-red-100 text-red-700', icon: 'x-circle' }
        };
        return map[state] || map['draft'];
    };

    const handleWorkflowAction = (transition) => {
        setCurrentDoc(prev => ({
            ...prev,
            workflow_state: transition.next_state,
            docstatus: transition.action.startsWith('approve') ? 1 : prev.docstatus
        }));
    };

    const statusBadge = getStatusBadge(currentDoc.workflow_state);

    return React.createElement('div', { className: 'max-w-3xl mx-auto p-6 bg-white rounded-xl shadow' }, [
        // Header
        React.createElement('div', { key: 'header', className: 'border-b pb-4 mb-6 flex justify-between items-center' }, [
            React.createElement('div', { key: 'title' },
                React.createElement('h1', { className: 'text-2xl font-bold text-gray-900' }, currentDoc.title),
                React.createElement('p', { className: 'text-sm text-gray-500' }, `Document ID: ${currentDoc.id} • Amount: $${currentDoc.amount.toLocaleString()} • User: ${currentDoc.current_user}`)
            ),
            React.createElement('div', { key: 'status', className: `flex items-center space-x-2 px-4 py-2 rounded-full ${statusBadge.color}` },
                React.createElement(Icon, { name: statusBadge.icon }),
                React.createElement('span', null, statusBadge.label)
            )
        ]),
        // Workflow Buttons
        React.createElement('div', { key: 'buttons', className: 'mb-6' },
            React.createElement(WorkflowButtons, { currentDoc, workflow: workflowJson, user: { role: 'sales_manager' }, onAction: handleWorkflowAction })
        ),
        // Test buttons for quick state change
        React.createElement('div', { key: 'test', className: 'mt-4 space-x-2' }, [
            ['draft','pending_l1_approval','pending_l2_approval','pending_l3_approval','approved','rejected'].map(s =>
                React.createElement('button', {
                    key: s,
                    className: 'px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm',
                    onClick: () => setCurrentDoc(prev => ({ ...prev, workflow_state: s, docstatus: s.startsWith('approved') ? 1 : 0 }))
                }, s)
            )
        ])
    ]);
};

ReactDOM.createRoot(document.getElementById('root')).render(
    React.createElement(ApprovalEnhancedDocumentUI)
);
</script>
</body>
</html>
